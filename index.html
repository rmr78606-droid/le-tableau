<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Le Tableau | Premium Art</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
/* 1. SETUP */
:root { --p: #111; --s: #fff; --acc: #cba374; --ease: cubic-bezier(0.25, 1, 0.5, 1); }
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
body { background: var(--s); color: var(--p); padding-top: 32px; overflow-x: hidden; }

/* 2. CURSOR & INTERACTION FIXES */
a, button, .btn, .card, .payment-option, .size, .frame-opt, .nav-icon-wrap, .close-icon, .heart-btn {
  cursor: pointer !important; transition: all 0.3s var(--ease);
}
button:active, .btn:active { transform: scale(0.96); }

/* 3. ANIMATIONS */
.page-section { display: none; padding-top: 80px; min-height: 100vh; animation: fadeUp 0.6s var(--ease) forwards; }
#main-page { padding-top: 0; display: block; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes heartBeat { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

/* 4. HEADER */
.announcement-bar { background: var(--p); color: var(--s); font-size: 11px; height: 32px; line-height: 32px; position: fixed; top: 0; width: 100%; z-index: 2000; text-align: center; font-weight: 700; letter-spacing: 1px; }
nav { display: flex; justify-content: space-between; align-items: center; padding: 15px 50px; position: fixed; width: 100%; top: 32px; background: rgba(255,255,255,0.95); z-index: 1000; border-bottom: 1px solid #eee; }
.logo { font-family: 'Cinzel', serif; font-size: 24px; font-weight: 700; }
.nav-links a { margin: 0 15px; font-weight: 600; font-size: 12px; text-transform: uppercase; color: var(--p); }
.nav-icons { display: flex; gap: 20px; align-items: center; }
.nav-icon-wrap { position: relative; }
.badge { position: absolute; top: -5px; right: -8px; background: var(--p); color: var(--s); font-size: 9px; width: 16px; height: 16px; border-radius: 50%; display: flex; justify-content: center; align-items: center; opacity: 0; }
.badge.visible { opacity: 1; }
svg { width: 24px; height: 24px; fill: none; stroke: var(--p); stroke-width: 2; }

/* 5. DRAWERS (CART & WISHLIST) */
.overlay-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; backdrop-filter: blur(4px); }
.overlay-bg.active { display: block; }
.drawer { position: fixed; top: 0; right: -450px; width: 450px; height: 100%; background: #fff; z-index: 3001; transition: 0.5s var(--ease); display: flex; flex-direction: column; box-shadow: -5px 0 30px rgba(0,0,0,0.1); }
.drawer.open { right: 0; }
.drawer-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
.drawer-body { flex: 1; overflow-y: auto; padding: 20px; }
.drawer-footer { padding: 20px; border-top: 1px solid #eee; background: #f9f9f9; }
.d-item { display: flex; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
.d-item img { width: 70px; height: 90px; object-fit: cover; border-radius: 4px; }
.d-title { font-weight: 600; font-size: 13px; }
.d-price { font-weight: 700; font-size: 14px; margin-top: 5px; }
.d-remove { color: #c00; font-size: 11px; text-decoration: underline; margin-top: 5px; }

/* 6. HERO & GRID */
.hero { min-height: 100vh; background: linear-gradient(rgba(0,0,0,0.2),rgba(0,0,0,0.2)), url("hero.jpg") center/cover; display: flex; align-items: center; justify-content: center; text-align: center; color: #fff; }
.hero h1 { font-family: 'Cinzel'; font-size: 56px; margin-bottom: 20px; }
.btn { padding: 15px 40px; background: #fff; color: #111; font-weight: 700; border: none; text-transform: uppercase; }
.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; padding: 60px; }
.card { position: relative; }
.card-img-wrap { position: relative; aspect-ratio: 3/4; overflow: hidden; background: #f5f5f5; margin-bottom: 15px; }
.card img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
.card:hover img { transform: scale(1.05); }
.heart-btn { position: absolute; top: 10px; right: 10px; width: 35px; height: 35px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; justify-content: center; align-items: center; z-index: 5; opacity: 0; }
.card:hover .heart-btn { opacity: 1; }
.heart-btn.active svg { fill: #e31b23; stroke: #e31b23; animation: heartBeat 0.4s; }

/* 7. PRODUCT PAGE */
.product-wrap { max-width: 1100px; margin: 0 auto; padding: 40px; display: flex; gap: 60px; }
.product-image { flex: 1; } .product-image img { width: 100%; }
.product-info { flex: 1; }
.sizes { display: flex; gap: 10px; margin: 20px 0; }
.size { padding: 12px 20px; border: 1px solid #ddd; font-size: 13px; font-weight: 600; }
.size.active { background: #000; color: #fff; border-color: #000; }
.add-btn { width: 100%; padding: 18px; background: #000; color: #fff; font-weight: 700; border: none; text-transform: uppercase; margin-top: 20px; }

/* 8. CHECKOUT (DEJAVU STYLE) */
.checkout-container { display: grid; grid-template-columns: 1.2fr 0.8fr; min-height: 100vh; border-top: 1px solid #eee; }
.checkout-left { padding: 50px 80px; border-right: 1px solid #eee; }
.checkout-right { padding: 50px; background: #fafafa; position: sticky; top: 0; height: 100vh; overflow-y: auto; }
.checkout-left h2 { font-family: 'Cinzel'; margin-bottom: 30px; font-size: 24px; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 5px; color: #666; text-transform: uppercase; }
.form-group input { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 5px; }
.payment-box { border: 1px solid #ddd; border-radius: 5px; margin-top: 20px; overflow: hidden; }
.payment-option { padding: 18px; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 15px; }
.payment-option.active { background: #fdfdfd; border-left: 4px solid #000; }
.payment-option input { transform: scale(1.3); accent-color: #000; }
.pay-btn-final { width: 100%; padding: 20px; background: #000; color: #fff; font-weight: 700; border: none; border-radius: 5px; margin-top: 25px; text-transform: uppercase; }

@media(max-width:900px){ .checkout-container{grid-template-columns:1fr;} .checkout-right{order:-1; height:auto; position:static; border-bottom:1px solid #eee;} .product-wrap{flex-direction:column;} .drawer{width:100%;} nav{padding:15px 20px;} .nav-links{display:none;} }
</style>
</head>
<body>

<div class="overlay-bg" id="overlay" onclick="closeAllDrawers()"></div>

<div class="drawer" id="cartDrawer">
  <div class="drawer-header"><h3>Shopping Cart</h3><button class="close-icon" onclick="closeAllDrawers()">✕</button></div>
  <div class="drawer-body" id="cartBody"><p style="text-align:center;color:#999;margin-top:50px;">Empty</p></div>
  <div class="drawer-footer">
    <div style="display:flex;justify-content:space-between;font-weight:bold;margin-bottom:15px;"><span>Total</span><span id="cartTotal">0 EGP</span></div>
    <button class="btn" style="width:100%;background:#000;color:#fff;" onclick="goToCheckout()">CHECKOUT</button>
  </div>
</div>

<div class="drawer" id="wishDrawer">
  <div class="drawer-header"><h3>Your Wishlist</h3><button class="close-icon" onclick="closeAllDrawers()">✕</button></div>
  <div class="drawer-body" id="wishBody"><p style="text-align:center;color:#999;margin-top:50px;">No items yet.</p></div>
</div>

<div class="announcement-bar"><div class="announcement-content">✨ FREE SHIPPING ON ORDERS OVER 1500 EGP</div></div>
<nav>
  <div class="logo" onclick="showPage('main-page')">Le Tableau</div>
  <div class="nav-links">
    <a onclick="loadCollection('Shop All')">Shop</a>
    <a onclick="loadCollection('Modern')">Modern</a>
    <a onclick="loadCollection('Islamic')">Islamic</a>
  </div>
  <div class="nav-icons">
    <div class="nav-icon-wrap" onclick="openDrawer('wishDrawer')">
      <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
      <span class="badge" id="wishBadge">0</span>
    </div>
    <div class="nav-icon-wrap" onclick="openDrawer('cartDrawer')">
      <svg viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
      <span class="badge" id="cartBadge">0</span>
    </div>
  </div>
</nav>

<div id="main-page" class="page-section" style="display:block;">
  <div class="hero"><div class="hero-content"><h1>Art That Speaks</h1><button class="btn" onclick="loadCollection('Shop All')">Shop Now</button></div></div>
  <div class="grid" id="mainGrid"></div>
</div>

<div id="collection-page" class="page-section">
  <h1 id="collTitle" style="text-align:center; margin-bottom:40px; font-family:'Cinzel';">Collection</h1>
  <div class="grid" id="collGrid"></div>
</div>

<div id="product-page" class="page-section">
  <div class="product-wrap">
    <div class="product-image"><img id="pImg" src=""></div>
    <div class="product-info">
      <h2 id="pTitle" style="font-family:'Cinzel'; margin-bottom:10px;">Title</h2>
      <h3 id="pPrice" style="color:#555;">450 EGP</h3>
      <p style="margin:20px 0; color:#666; line-height:1.6;">Premium quality museum-grade paper with archival inks.</p>
      
      <p style="font-weight:bold; font-size:12px; margin-bottom:10px;">SIZE</p>
      <div class="sizes">
        <div class="size active" onclick="setSize(this)">30x40 CM</div>
        <div class="size" onclick="setSize(this)">40x60 CM</div>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <button class="add-btn" onclick="addCurrentToCart()">ADD TO CART</button>
        <div class="nav-icon-wrap" style="border:1px solid #ddd; padding:10px; margin-top:20px; border-radius:4px;" onclick="toggleWishCurrent()">
            <svg id="pHeart" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="checkout-page" class="page-section" style="padding-top:0;">
  <div class="checkout-container">
    <div class="checkout-left">
      <h2>Checkout</h2>
      <div class="form-group"><label>Email</label><input type="email" id="cEmail"></div>
      <div class="form-group"><label>Full Name</label><input type="text" id="cName"></div>
      <div class="form-group"><label>Address</label><input type="text" id="cAddr"></div>
      <div class="form-group"><label>Phone</label><input type="tel" id="cPhone"></div>
      
      <div style="margin-top:30px; font-weight:bold;">Payment Method</div>
      <div class="payment-box">
        <div class="payment-option active" onclick="setPay('CARD', this)">
          <input type="radio" name="pay" checked> <span>Credit / Debit Card (Paymob)</span>
        </div>
        <div class="payment-option" onclick="setPay('COD', this)">
          <input type="radio" name="pay"> <span>Cash on Delivery</span>
        </div>
      </div>
      <button class="pay-btn-final" id="payBtn" onclick="processPayment()">PAY NOW</button>
    </div>
    
    <div class="checkout-right">
      <div id="checkoutItems"></div>
      <div style="border-top:1px solid #ddd; padding-top:20px; margin-top:20px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>Subtotal</span><span id="chkSub">0 EGP</span></div>
        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:18px;"><span>Total</span><span id="chkTotal">0 EGP</span></div>
      </div>
    </div>
  </div>
</div>
<script>
// ============================================
// 1. DATA & CONFIGURATION
// ============================================
const products = [
  { t: "Abstract Lines", i: "https://picsum.photos/600/800?1", c: "Modern", p: 450 },
  { t: "Desert Vibes", i: "https://picsum.photos/600/800?2", c: "Modern", p: 450 },
  { t: "Geometry I", i: "https://picsum.photos/600/800?3", c: "Modern", p: 450 },
  { t: "Golden Touch", i: "https://picsum.photos/600/800?6", c: "Islamic", p: 550 },
  { t: "Mountain Mist", i: "https://picsum.photos/600/800?7", c: "Islamic", p: 550 },
  { t: "Urban Night", i: "https://picsum.photos/600/800?8", c: "Games", p: 450 },
  { t: "Neon City", i: "https://picsum.photos/600/800?9", c: "Games", p: 450 },
  { t: "Minimalist", i: "https://picsum.photos/600/800?12", c: "Quotes", p: 350 }
];

// PAYMOB REAL KEYS (بياناتك)
const API_KEY = "ZXlKaGJHY2lPaUpJVXpVeE1pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SmpiR0Z6Y3lJNklrMWxjbU5vWVc1MElpd2ljSEp2Wm1sc1pWOXdheUk2TVRFek1EUXdNeXdpYm1GdFpTSTZJbWx1YVhScFlXd2lmUS5POHUyUjU0OTdJMlZKNFJTbzFVdXhoOHAtaDdHLUVULUFVcU5wSjdWdE9NOE8tcTdZUDUtS1NVS3ZXc3RmNHhVeTNrVkxVX2R3dnRSdTNsajA5V09ZZw==";
const INT_ID = 5511043;
const IFRAME_ID = 1005719;

let cart = [];
let wishlist = []; // Love List
let payMode = 'CARD';

// ============================================
// 2. NAVIGATION & UI
// ============================================
window.onload = () => {
    // Show Welcome Popup
    setTimeout(() => { 
        document.getElementById('modalOverlay').classList.add('active');
        document.getElementById('welcomeModal').classList.add('active');
    }, 2000);
    renderGrid('Shop All'); 
};

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
    document.getElementById('welcomeModal').classList.remove('active');
}

function showSection(id) {
    document.querySelectorAll('.page-section').forEach(s => s.style.display = 'none');
    const target = document.getElementById(id);
    if(target) {
        target.style.display = 'block';
        window.scrollTo(0,0);
    }
}
function goHome() { showSection('main-page'); }

function openCollection(cat) {
    renderGrid(cat);
    document.getElementById('collectionTitle').innerText = cat;
    showSection('collection-page');
}

// ============================================
// 3. PRODUCT & GRID LOGIC
// ============================================
function renderGrid(cat) {
    const targetGrid = document.getElementById(cat === 'Shop All' ? 'productGrid' : 'homeGrid');
    if(!targetGrid) return; // safety check
    
    targetGrid.innerHTML = "";
    let list = (cat === 'Shop All') ? products : products.filter(p => p.c === cat);
    if(list.length < 1) list = products; // Fallback
    
    // Duplicate to fill grid for demo
    if(list.length < 8) list = list.concat(list);

    list.forEach(p => {
        let isLoved = wishlist.some(x => x.t === p.t) ? 'active' : '';
        targetGrid.innerHTML += `
        <div class="card">
            <div class="card-img-wrap" onclick="openProd('${p.t}', '${p.i}', ${p.p})">
                <img src="${p.i}">
                <span class="card-badge">SALE</span>
            </div>
            <div class="heart-btn ${isLoved}" onclick="toggleWish('${p.t}', '${p.i}', ${p.p}, this)">
                <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
            </div>
            <div style="padding:15px 5px;">
                <h4 style="font-size:14px; font-weight:600; margin-bottom:5px;">${p.t}</h4>
                <div style="font-weight:700;">${p.p} EGP</div>
            </div>
        </div>`;
    });
}

function openProd(t, i, p) {
    document.getElementById('pInfoTitle').innerText = t;
    document.getElementById('pInfoImg').src = i;
    document.getElementById('pInfoPrice').innerText = p + " EGP";
    
    // Check Wishlist Status for the big button
    const btn = document.getElementById('pInfoHeart');
    if(wishlist.some(x => x.t === t)) {
        btn.classList.add('active');
        btn.querySelector('svg').style.fill = "#e31b23";
        btn.querySelector('svg').style.stroke = "#e31b23";
    } else {
        btn.classList.remove('active');
        btn.querySelector('svg').style.fill = "none";
        btn.querySelector('svg').style.stroke = "#111";
    }
    showSection('product-page');
}

function selectSize(el) {
    document.querySelectorAll('.size').forEach(x => x.classList.remove('active'));
    el.classList.add('active');
}

// ============================================
// 4. CART & WISHLIST LOGIC
// ============================================
function addToCartCurrent() {
    const t = document.getElementById('pInfoTitle').innerText;
    const i = document.getElementById('pInfoImg').src;
    const p = parseInt(document.getElementById('pInfoPrice').innerText);
    cart.push({t, i, p});
    updateCartUI();
    toggleCartDrawer();
}

function updateCartUI() {
    document.getElementById('cartBadge').innerText = cart.length;
    document.getElementById('cartBadge').classList.add('visible');
    const c = document.getElementById('cartItemsContainer');
    
    if(cart.length === 0) {
        c.innerHTML = '<p style="text-align:center; color:#999; margin-top:50px;">Empty</p>';
    } else {
        c.innerHTML = "";
        let total = 0;
        cart.forEach((item, idx) => {
            total += item.p;
            c.innerHTML += `
            <div class="d-item">
                <img src="${item.i}">
                <div class="d-info">
                    <div class="d-title">${item.t}</div>
                    <div class="d-price">${item.p} EGP</div>
                    <div class="d-remove" onclick="cart.splice(${idx},1);updateCartUI()">Remove</div>
                </div>
            </div>`;
        });
        document.getElementById('cartTotal').innerText = total + " EGP";
    }
}

function toggleCartDrawer() {
    const d = document.getElementById('cartDrawer');
    const o = document.getElementById('drawerOverlay');
    document.getElementById('wishlistDrawer').classList.remove('open'); // close others
    if(d.classList.contains('open')) { d.classList.remove('open'); o.classList.remove('active'); }
    else { d.classList.add('open'); o.classList.add('active'); }
}

function closeDrawers() {
    document.getElementById('cartDrawer').classList.remove('open');
    document.getElementById('wishlistDrawer').classList.remove('open');
    document.getElementById('drawerOverlay').classList.remove('active');
}

// --- WISHLIST ---
function toggleWishlistDrawer() {
    const d = document.getElementById('wishlistDrawer');
    const o = document.getElementById('drawerOverlay');
    document.getElementById('cartDrawer').classList.remove('open');
    if(d.classList.contains('open')) { d.classList.remove('open'); o.classList.remove('active'); }
    else { d.classList.add('open'); o.classList.add('active'); }
}

function toggleWish(t, i, p, btn) {
    const idx = wishlist.findIndex(x => x.t === t);
    if(idx === -1) {
        // Add
        wishlist.push({t, i, p});
        if(btn) { 
            btn.classList.add('active'); 
            btn.querySelector('svg').style.fill = "#e31b23"; 
            btn.querySelector('svg').style.stroke = "#e31b23";
        }
    } else {
        // Remove
        wishlist.splice(idx, 1);
        if(btn) { 
            btn.classList.remove('active'); 
            btn.querySelector('svg').style.fill = "none"; 
            btn.querySelector('svg').style.stroke = "#111";
        }
    }
    updateWishUI();
}

function toggleWishCurrent() {
    const t = document.getElementById('pInfoTitle').innerText;
    const i = document.getElementById('pInfoImg').src;
    const p = parseInt(document.getElementById('pInfoPrice').innerText);
    toggleWish(t, i, p, null);
    
    // Manual UI toggle for current page button
    const btn = document.getElementById('pInfoHeart');
    if(btn.classList.contains('active')) {
        btn.classList.remove('active'); 
        btn.querySelector('svg').style.fill = "none"; 
        btn.querySelector('svg').style.stroke = "#111";
    } else {
        btn.classList.add('active'); 
        btn.querySelector('svg').style.fill = "#e31b23"; 
        btn.querySelector('svg').style.stroke = "#e31b23";
    }
}

function updateWishUI() {
    document.getElementById('wishlistBadge').innerText = wishlist.length;
    document.getElementById('wishlistBadge').classList.add('visible');
    const c = document.getElementById('wishlistItemsContainer');
    
    if(wishlist.length === 0) {
        c.innerHTML = '<p style="text-align:center; color:#999; margin-top:50px;">No items yet.</p>';
    } else {
        c.innerHTML = "";
        wishlist.forEach((item, idx) => {
            c.innerHTML += `
            <div class="d-item">
                <img src="${item.i}">
                <div class="d-info">
                    <div class="d-title">${item.t}</div>
                    <div class="d-remove" onclick="wishlist.splice(${idx},1);updateWishUI()">Remove</div>
                </div>
                <button class="btn" style="padding:5px 10px; font-size:10px;" onclick="cart.push({t:'${item.t}',i:'${item.i}',p:${item.p}});updateCartUI();toggleCartDrawer()">ADD</button>
            </div>`;
        });
    }
}

// ============================================
// 5. CHECKOUT & PAYMOB
// ============================================
function openCheckout() {
    if(cart.length === 0) return alert("Cart is empty");
    closeDrawers();
    
    // Fill Summary
    const con = document.getElementById('checkoutItems');
    con.innerHTML = "";
    let total = 0;
    cart.forEach(item => {
        total += item.p;
        con.innerHTML += `
        <div class="d-item">
            <div style="position:relative;">
                <img src="${item.i}" style="width:60px; height:60px;">
                <span style="position:absolute; top:-5px; right:-5px; background:#777; color:#fff; border-radius:50%; width:20px; height:20px; font-size:10px; display:flex; justify-content:center; align-items:center;">1</span>
            </div>
            <div class="d-info" style="margin-left:15px; display:flex; align-items:center; justify-content:space-between;">
                <span style="font-weight:600; font-size:13px;">${item.t}</span>
                <span style="font-weight:600;">${item.p} EGP</span>
            </div>
        </div>`;
    });
    
    document.getElementById('chkSubtotal').innerText = total + " EGP";
    document.getElementById('chkTotal').innerText = total + " EGP";
    showSection('checkout-page');
}

function setPay(mode, el) {
    payMode = mode;
    document.querySelectorAll('.payment-option').forEach(x => x.classList.remove('active'));
    el.classList.add('active');
    el.querySelector('input').checked = true;
    document.getElementById('payBtn').innerText = (mode === 'COD') ? "COMPLETE ORDER" : "PAY NOW";
}

async function submitOrder() {
    const fname = document.getElementById('cFname').value;
    const lname = document.getElementById('cLname').value;
    const phone = document.getElementById('cPhone').value;
    const addr = document.getElementById('cAddr').value;
    const email = document.getElementById('cEmail').value || "guest@test.com";

    if(!fname || !phone || !addr) return alert("Please fill shipping details");

    let amount = parseFloat(document.getElementById('chkTotal').innerText) * 100;

    if(payMode === 'COD') {
        window.open(`https://wa.me/201000000000?text=Order:${fname},${amount/100}EGP`, '_blank');
        return;
    }

    // Paymob Flow
    const btn = document.getElementById('payBtn');
    btn.innerText = "Processing...";
    btn.disabled = true;

    try {
        let auth = await fetch("https://accept.paymob.com/api/auth/tokens", {
            method: "POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify({api_key: API_KEY})
        }).then(r=>r.json());

        let order = await fetch("https://accept.paymob.com/api/ecommerce/orders", {
            method: "POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify({
                auth_token: auth.token,
                delivery_needed: "false",
                amount_cents: amount,
                currency: "EGP",
                items: []
            })
        }).then(r=>r.json());

        let key = await fetch("https://accept.paymob.com/api/acceptance/payment_keys", {
            method: "POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify({
                auth_token: auth.token,
                amount_cents: amount,
                expiration: 3600,
                order_id: order.id,
                billing_data: {
                    apartment: "NA", email: email, floor: "NA", 
                    first_name: fname, street: addr, building: "NA", 
                    phone_number: phone, shipping_method: "NA", 
                    postal_code: "NA", city: "Cairo", country: "EG", 
                    last_name: lname, state: "NA"
                },
                currency: "EGP",
                integration_id: INT_ID
            })
        }).then(r=>r.json());

        if (key.token) {
            window.location.href = `https://accept.paymob.com/api/acceptance/iframes/${IFRAME_ID}?payment_token=${key.token}`;
        } else {
            alert("Payment Token Error");
            btn.disabled = false;
        }

    } catch(e) {
        console.error(e);
        alert("Connection Error");
        btn.disabled = false;
        btn.innerText = "PAY NOW";
    }
}
</script>
</body>
</html>
